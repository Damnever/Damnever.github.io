<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Damnever'd Blog, 人在 Qi 途.">

    <title>工厂方法模式在 Python 中的应用 &laquo; Damnever's Blog</title>

    <link rel="icon" href="/img/damnever.png"/>
    <link rel="shortcut icon" href="/img/favicon.ico"/>
    <link rel="Bookmark" href="/img/favicon.ico"/>
    <link rel="canonical" href="/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/python/2015/03/29/factory-method-pattern-in-python/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Damnever's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <!--
                
                <li>
                    <a href="/example_post/2014-06-10-dinosaurs/">Dinosaurs are extinct today</a>
                </li>
                
                <li>
                    <a href="/example_post/2014-07-01-dreams/">The dreams of yesterday.</a>
                </li>
                
                <li>
                    <a href="/example_post/2014-07-08-failure-is-not-an-option/">Failure is not an option</a>
                </li>
                
                <li>
                    <a href="/example_post/2015-01-18-i-believe/">I don't intend to waste any of mine.</a>
                </li>
                
                <li>
                    <a href="/example_post/2015-01-24-man-must-explore/">Man must explore</a>
                </li>
                
                <li>
                    <a href="/example_post/2015-01-24-science-has-not-yet-mastered-prophecy/">Science has not yet mastered prophecy</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/categories/">Category</a>
                </li>
                
                <li>
                    <a href="/tags/">Tag</a>
                </li>
                
                -->
                <li><a href="/categories/" title="categories">CATEGORIES</a></li>
                <li><a href="/tags/" title="tags">TAGS</a></li>
                <li><a href="/about/" title="about">ABOUT</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/post-bg.jpg'); height: 330px;">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h2>工厂方法模式在 Python 中的应用</h2>
                    
                    <h4 class="subheading">坑爹的 Win10 + A卡让我玩不了 LOL，%>_<%，于是在 Ubuntu 下诞生了这个 Blog</h4>
                    
<ul class="tag-box inline"">



<li><a class="tag" href="/tags/#Python">Python</a></li>

<li><a class="tag" href="/tags/#工厂方法模式">工厂方法模式</a></li>

<li><a class="tag" href="/tags/#Tornado">Tornado</a></li>



</ul>
<span class="meta">By Damnever on   March 29, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>每过一阵子总有那么几天，想要手残一下。这不又格式化了整个硬盘，重装了双系统。结果 Win10+A卡 玩不了撸啊撸了…… 只好老老实实回到 Ubuntu，在网上乱入发现了这张图，给我的逃课行为提供了有力的支撑～</p>

<p><img src="/img/post/2015-03-28.jpg" alt="2015-03-28" /></p>

<p>然后，这个基于<code>git-pages</code>的 Blog 也随之诞生了。</p>

<hr />
<p>    扯谈的分割区</p>

<hr />

<p>不知天高地厚的看了一下<code>Tornado</code>的<code>ioloop</code>模块的源码，结果是毫无头绪，其它的就暂且不说。<code>tornado.ioloop.IOLoop.instance().start()</code>是用来启动<code>Tornado</code>的，但是在源码里面<code>IOLoop().start()</code>压根就没实现，子类<code>PollIOLoop().start()</code>倒是实现了。看看<code>instance()</code>到底是啥：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="lineno">2</span> <span class="o">&gt;&gt;&gt;</span> <span class="nb">repr</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">())</span>
<span class="lineno">3</span> <span class="s">&#39;&lt;tornado.platform.epoll.EPollIOLoop object at 0x7f4ac177ae50&gt;&#39;</span></code></pre></div>

<p>哪里又冒出了一个<code>EPollIOLoop</code>?</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">继承关系</span><span class="p">:</span>
                    <span class="o">+-------------------+</span>
                    <span class="o">|</span> <span class="n">util</span><span class="o">.</span><span class="n">Configurable</span> <span class="o">|</span>
                    <span class="o">+-------------------+</span>
                            <span class="o">^</span>
                            <span class="o">|</span>
                    <span class="o">+---------------+</span>
                    <span class="o">|</span> <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span> <span class="o">|</span>
                    <span class="o">+---------------+</span>
                            <span class="o">^</span>
                            <span class="o">|</span>
                    <span class="o">+-------------------+</span>     <span class="o">+------------------------------+</span>
                    <span class="o">|</span> <span class="n">ioloop</span><span class="o">.</span><span class="n">PollIOLoop</span> <span class="o">|</span> <span class="o">&lt;--</span> <span class="o">|</span> <span class="n">platform</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">SelectIOLoop</span> <span class="o">|</span>
                    <span class="o">+-------------------+</span>     <span class="o">+------------------------------+</span>
                         <span class="o">^</span>            <span class="o">^</span>
                         <span class="o">|</span>            <span class="o">|</span>
<span class="o">+----------------------------+</span>    <span class="o">+------------------------------+</span>
<span class="o">|</span> <span class="n">platform</span><span class="o">.</span><span class="n">epoll</span><span class="o">.</span><span class="n">EpollIOLoop</span> <span class="o">|</span>    <span class="o">|</span> <span class="n">platform</span><span class="o">.</span><span class="n">kqueue</span><span class="o">.</span><span class="n">KQueueIOLoop</span> <span class="o">|</span>
<span class="o">+----------------------------+</span>    <span class="o">+------------------------------+</span></code></pre></div>

<p><code>util.Configurable</code>的文档是这样描述的：Base class for configurable interfaces.这是个抽象类，它的构造函数(<span id="r1">这里是说<code>initialize()</code>，通过<code>__new__()</code>来调用<a href="#1">[1]</a></span>)给其实现子类之一(应该就是这厮了<code>ioloop.IOLoop</code>)扮演工厂函数的角色。还说了其实现子类可以用<code>configure()</code>在运行时全局的改变实例，不过这里貌似没用到。通过用<code>initialize()</code>作为工厂方法，这个接口就像正常的类一样，<code>isinstance</code>之类的方法都可以正常使用。这种模式在这些时候是最有用的：当选择的实现可能是一个全局的决定时（如果<code>epoll</code>可用就会代替<code>select</code>，在*unix上都可用），或者<code>previously-monolithic class</code>(what?)被分为特定的子类时。</p>

<p>看了类文档，眼前一亮，难道这就是我们上节设计模式课所说的工厂方法模式，不是也是了，反正上课也没听太懂……</p>

<hr />

<p>又了上网了解一下工厂方法模式，拙谈这几个类的角色：</p>

<blockquote>
  <ul>
    <li><code>util.Configurable</code>：使用了黑魔法-元类，通过调用工厂方法<code>initialize()</code>来创建实例。抽象工厂。</li>
    <li><code>ioloop.IOLoop</code>：当你调用<code>tornado.ioloop.IOLoop.instance().start()</code>时，会根据你所使用的平台通过<code>configrable_defult()</code>来返回<code>SlectIOLoop</code>/<code>EpollIOLoop</code>/<code>KQueueIOLoop</code>中最佳的一个类给<code>util.Configurable</code>来创建实例。具体工厂。</li>
    <li><code>ioloop.PollIOLoop</code>：为<code>IOLoop</code>来创建接口一致的<code>select-like</code>方法。抽象产品。</li>
    <li><code>platform.select.SelectIOLoop/platform.epoll.EpollIOLoop/platform.kqueue.KQueueIOLoop</code>：这几个只有被选择的份，已经不能再具体了。具体产品。</li>
  </ul>
</blockquote>

<hr />

<p>还是来看一个代码片段，看看这个魔法是如何进行的：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="n">EPOLL</span><span class="p">,</span> <span class="n">SELECT</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="k">class</span> <span class="nc">Configurable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno"> 8</span>         <span class="n">impl</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">configurable_default</span><span class="p">()</span>
<span class="lineno"> 9</span>         <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Configurable</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span>
<span class="lineno">10</span>         <span class="n">instance</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="lineno">11</span>         <span class="k">return</span> <span class="n">instance</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>     <span class="nd">@classmethod</span>
<span class="lineno">14</span>     <span class="k">def</span> <span class="nf">configurable_default</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
<span class="lineno">15</span>         <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>     <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c"># 都可以替换成 __init__，因为__init__ 并不是构造函数</span>
<span class="lineno">18</span>         <span class="sd">&quot;&quot;&quot; 工厂方法 &quot;&quot;&quot;</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="k">class</span> <span class="nc">IOLoop</span><span class="p">(</span><span class="n">Configurable</span><span class="p">):</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>     <span class="nd">@staticmethod</span>
<span class="lineno">24</span>     <span class="k">def</span> <span class="nf">instance</span><span class="p">():</span>
<span class="lineno">25</span>         <span class="sd">&quot;&quot;&quot; 简单的单例模式 &quot;&quot;&quot;</span>
<span class="lineno">26</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">IOLoop</span><span class="p">,</span> <span class="s">&#39;_instance&#39;</span><span class="p">):</span>
<span class="lineno">27</span>             <span class="n">IOLoop</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="p">()</span>
<span class="lineno">28</span>         <span class="k">print</span><span class="p">(</span><span class="s">&quot;IOLoop -&gt; instance()&quot;</span><span class="p">)</span>
<span class="lineno">29</span>         <span class="k">return</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">_instance</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>     <span class="nd">@classmethod</span>
<span class="lineno">32</span>     <span class="k">def</span> <span class="nf">configurable_default</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
<span class="lineno">33</span>         <span class="k">print</span><span class="p">(</span><span class="s">&quot;IOLoop -&gt; configurable_default()&quot;</span><span class="p">)</span>
<span class="lineno">34</span>         <span class="k">if</span> <span class="n">EPOLL</span><span class="p">:</span> <span class="c"># 假设 EPOLL是最佳方式</span>
<span class="lineno">35</span>             <span class="k">return</span> <span class="n">EPollIOLoop</span>
<span class="lineno">36</span>         <span class="k">return</span> <span class="n">SelectIOLoop</span>
<span class="lineno">37</span> 
<span class="lineno">38</span>     <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">39</span>         <span class="k">print</span><span class="p">(</span><span class="s">&quot;IOLoop -&gt; initialize()&quot;</span><span class="p">)</span>
<span class="lineno">40</span>         <span class="k">pass</span>
<span class="lineno">41</span> 
<span class="lineno">42</span> 
<span class="lineno">43</span> <span class="k">class</span> <span class="nc">PollIOLoop</span><span class="p">(</span><span class="n">IOLoop</span><span class="p">):</span>
<span class="lineno">44</span> 
<span class="lineno">45</span>     <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">impl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno">46</span>         <span class="k">print</span><span class="p">(</span><span class="s">&quot;PollIOLoop -&gt; initialize()&quot;</span><span class="p">)</span>
<span class="lineno">47</span>         <span class="nb">super</span><span class="p">(</span><span class="n">PollIOLoop</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="lineno">48</span> 
<span class="lineno">49</span> 
<span class="lineno">50</span> <span class="k">class</span> <span class="nc">EPollIOLoop</span><span class="p">(</span><span class="n">PollIOLoop</span><span class="p">):</span>
<span class="lineno">51</span> 
<span class="lineno">52</span>     <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno">53</span>         <span class="k">print</span><span class="p">(</span><span class="s">&quot;EPollIOLoop -&gt; initialize()&quot;</span><span class="p">)</span>
<span class="lineno">54</span>         <span class="nb">super</span><span class="p">(</span><span class="n">EPollIOLoop</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">impl</span><span class="o">=</span><span class="n">EPOLL</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="lineno">55</span> 
<span class="lineno">56</span> 
<span class="lineno">57</span> <span class="k">class</span> <span class="nc">SelectIOLoop</span><span class="p">(</span><span class="n">PollIOLoop</span><span class="p">):</span>
<span class="lineno">58</span> 
<span class="lineno">59</span>     <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno">60</span>         <span class="k">print</span><span class="p">(</span><span class="s">&quot;SelectIOLoop -&gt; initialize()&quot;</span><span class="p">)</span>
<span class="lineno">61</span>         <span class="nb">super</span><span class="p">(</span><span class="n">SelectIOLoop</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">impl</span><span class="o">=</span><span class="n">SELECT</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="lineno">62</span> 
<span class="lineno">63</span> <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
<span class="lineno">64</span>     <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()))</span>
<span class="lineno">65</span> 	<span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()))</span></code></pre></div>

<p>输出</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">IOLoop</span> <span class="o">-&gt;</span> <span class="n">configurable_default</span><span class="p">()</span>
<span class="lineno">2</span> <span class="n">EPollIOLoop</span> <span class="o">-&gt;</span> <span class="n">initialize</span><span class="p">()</span>
<span class="lineno">3</span> <span class="n">PollIOLoop</span> <span class="o">-&gt;</span> <span class="n">initialize</span><span class="p">()</span>
<span class="lineno">4</span> <span class="n">IOLoop</span> <span class="o">-&gt;</span> <span class="n">initialize</span><span class="p">()</span>
<span class="lineno">5</span> <span class="n">IOLoop</span> <span class="o">-&gt;</span> <span class="n">instance</span><span class="p">()</span>
<span class="lineno">6</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="o">.</span><span class="n">EPollIOLoop</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7f91f7da1590</span><span class="o">&gt;</span>  <span class="c"># 两个对象id一致</span>
<span class="lineno">7</span> <span class="n">IOLoop</span> <span class="o">-&gt;</span> <span class="n">instance</span><span class="p">()</span>
<span class="lineno">8</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="o">.</span><span class="n">EPollIOLoop</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7f91f7da1590</span><span class="o">&gt;</span></code></pre></div>

<p>在这里<code>Configurable</code>是一个元类，他被隐式的继承到了子类<code>IOLoop</code>，所以在<code>IOLoop.instance()</code>里调用<code>IOLoop()</code>时，会调用<code>__new__()</code>来实例化一个对象，调用<code>__new__</code>的时候会调用<code>IOLoop.configurable_default()</code>来获取一个最佳的选择（<code>EPollIOLoop</code>）,然后实例化这个选择，返回这个实例，所以<code>IOLoop()</code>得到了实例是一个<code>EPollIOLoop</code>对象。</p>

<p><strong>可以看出工厂方法模式的核心就是如何去实例化并得到一个具体的对象，而这个对象又恰恰是我们想要的。</strong></p>

<hr />

<p><span id="1" class="caption text-muted"><a href="#r1">[1]</a> <code>__init__()</code>并不是真正意义上的构造方法，<code>__init__()</code>所做的工作是在累的对象创建好之后进行变量的初始化。<code>__new__()</code>才会真正的创建实例，是累的构造方法。</span></p>

<hr />

<p><span class="fresh">原文链接：<a href="/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/python/2015/03/29/factory-method-pattern-in-python/">/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/python/2015/03/29/factory-method-pattern-in-python/</a>，转载请注明出处。</span></p>


                <hr>

                <ul class="pager">
                    
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/Damnever" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p id="footer" class="copyright text-muted">&copy; 2015  Damnever. Powered by <a class="text-muted" href="http://jekyllrb.com/" target="_blank">jekyll</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
